<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel urzędnika — BigBag</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}" />
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="brand" href="{{ url_for('index') }}">PłockiBigBag.pl</a>
      </div>
    </header>

    <main class="auth-viewport">
      <div class="auth-container">
        <div class="auth-card" role="main">
          <div id="dashboard-header">
            <h1>Panel urzędnika</h1>
          </div>
          <p class="lead">Lista wszystkich wniosków</p>

          <div style="margin-top: 1.5rem; width: 100%">
            <form method="get" action="" style="display:flex; gap:0.5rem; align-items:center; margin-bottom:0.75rem; flex-wrap:wrap;">
              <label for="filter_status">Status</label>
              <select id="filter_status" name="status">
                <option value="">Wszystkie</option>
                <option value="awaiting" {% if status_filter == 'awaiting' %}selected{% endif %}>Oczekujący</option>
                <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>W trakcie</option>
                <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Zatwierdzony</option>
                <option value="declined" {% if status_filter == 'declined' %}selected{% endif %}>Odrzucony</option>
              </select>
              <label for="filter_q">Szukaj</label>
              <input id="filter_q" name="q" type="search" placeholder="imię, nazwisko, ulica, email, rok (YYYY) lub data (YYYY-MM-DD)" value="{{ q or '' }}" />
              <button class="btn btn-primary" type="submit">Filtruj</button>
            </form>
            {% if applications and applications|length > 0 %}
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Wnioskodawca</th>
                    <th>Adres</th>
                    <th>Załącznik</th>
                    <th>Status</th>
                    <th>Worki</th>
                    <th>Data dostarczenia</th>
                    <th>Data odbioru</th>
                    <th>Utworzono</th>
                    <th>Akcje</th>
                  </tr>
                </thead>
                <tbody>
                  {% for a in applications %}
                  <tr>
                    <td>{{ a.id_application }}</td>
                    <td>
                      <button class="citizen-link" data-citizen-id="{{ a.id_citizen }}" style="border:0;background:transparent;padding:0;color:var(--text);font-weight:600;cursor:pointer;">
                        {{ a.first_name }} {{ a.last_name }}
                      </button>
                      <br/><small>{{ a.email }}</small>
                    </td>
                    <td>ul. {{ a.street }} {{ a.building_number }}{% if a.apartment_number %}/{{ a.apartment_number }}{% endif %}</td>
                    <td>
                      {% set atts = attachments_map.get(a.id_application) if attachments_map else None %}
                      {% if atts and atts|length > 0 %}
                        <div style="display:flex; gap:0.5rem; align-items:center; justify-content:center;">
                          {% for att in atts %}
                            {% set src = url_for('serve_attachment', attachment_id=att.id_attachment) %}
                            {% if att.file_type and (att.file_type.startswith('image/') or att.file_type == 'application/pdf') %}
                              {# show filename only, preview in modal on click #}
                              <button class="attachment-link" data-type="{{ 'image' if att.file_type.startswith('image/') else 'pdf' }}" data-src="{{ src }}" data-name="{{ att.file_name }}" style="border:0; background:transparent; padding:0; color:var(--accent); font-weight:600; text-decoration:underline; cursor:pointer;">
                                {{ att.file_name }}
                              </button>
                            {% else %}
                              <a class="action-link" href="{{ url_for('attachment_view', attachment_id=att.id_attachment) }}" target="_blank" rel="noopener">{{ att.file_name }}</a>
                            {% endif %}
                          {% endfor %}
                        </div>
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% set status_label = '???' %}
                      {% if a.status == 'awaiting' %}
                        {% set status_label = 'Oczekujący' %}
                      {% elif a.status == 'in_progress' %}
                        {% set status_label = 'W trakcie' %}
                      {% elif a.status == 'approved' %}
                        {% set status_label = 'Zatwierdzony' %}
                      {% elif a.status == 'declined' %}
                        {% set status_label = 'Odrzucony' %}
                      {% else %}
                        {% set status_label = a.status %}
                      {% endif %}
                      <span class="status-badge status-{{ a.status|replace(' ', '_') }}">{{ status_label }}</span>
                    </td>
                    <td class="bag-count">
                      {% set total = a.bag_count or 0 %}
                      {% set paid = (a.paid_bags if (a.paid_bags is defined) else 0) %}
                      {{ total }}{% if paid and paid > 0 %} <span class="paid-badge">{{ paid }} płatne</span>{% endif %}
                    </td>
                    <td>{{ a.bag_arrival_date or '-' }}</td>
                    <td>{{ a.bag_depart_date or '-' }}</td>
                    <td>{{ a.creation_date }}</td>
                    <td>
                      <div style="display:flex; gap:0.4rem; align-items:center;">
                        {% set att_names = '' %}
                        {% if atts and atts|length > 0 %}
                          {% set att_names = atts | map(attribute='file_name') | join('|||') %}
                        {% endif %}
                        <button class="btn btn-sm pickup-info"
                          data-street="{{ a.street }}"
                          data-building="{{ a.building_number }}"
                          data-apartment="{{ a.apartment_number or '' }}"
                          data-bag-count="{{ a.bag_count or 0 }}"
                          data-paid-bags="{{ (a.paid_bags if (a.paid_bags is defined) else 0) }}"
                          data-arrival="{{ a.bag_arrival_date or '' }}"
                          data-depart="{{ a.bag_depart_date or '' }}"
                          data-notes="{{ a.notes | e }}"
                          data-attachments="{{ att_names }}"
                        >Informacje o pobiorze</button>
                        <button class="btn btn-sm sector-info" data-sector-id="{{ a.id_sector or '' }}" data-sector-company="{{ a.managing_company or '' }}">Sektor</button>
                        <a class="btn" href="{{ url_for('application_print', app_id=a.id_application) }}?autoprint=1" target="_blank" rel="noopener">Pobierz PDF</a>
                        <button class="btn btn-primary ajax-decision" data-app-id="{{ a.id_application }}" data-action="approve">Zatwierdź</button>
                        <button class="btn btn-secondary ajax-decision" data-app-id="{{ a.id_application }}" data-action="decline">Odrzuć</button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p>Brak wniosków.</p>
            {% endif %}

            {% if total_pages and total_pages > 1 %}
            <div class="pagination-controls">
              {% set base_q = ('&q=' ~ q) if q else '' %}
              {% set base_status = ('&status=' ~ status_filter) if status_filter else '' %}
              {% if page > 1 %}
                <a class="btn" href="?page={{ page-1 }}{{ base_status }}{{ base_q }}">Poprzednia</a>
              {% else %}
                <span class="btn btn-secondary">Poprzednia</span>
              {% endif %}

              {% set start = page - 2 if page - 2 > 1 else 1 %}
              {% set end = page + 2 if page + 2 < total_pages else total_pages %}

              {% if start > 1 %}
                <a class="btn" href="?page=1{{ base_status }}{{ base_q }}">1</a>
                {% if start > 2 %}
                  <span class="btn btn-secondary">…</span>
                {% endif %}
              {% endif %}

              {% for p in range(start, end+1) %}
                {% if p == page %}
                  <span class="btn btn-secondary" style="font-weight:700;">{{ p }}</span>
                {% else %}
                  <a class="btn" href="?page={{ p }}{{ base_status }}{{ base_q }}">{{ p }}</a>
                {% endif %}
              {% endfor %}

              {% if end < total_pages %}
                {% if end < total_pages - 1 %}
                  <span class="btn btn-secondary">…</span>
                {% endif %}
                <a class="btn" href="?page={{ total_pages }}{{ base_status }}{{ base_q }}">{{ total_pages }}</a>
              {% endif %}

              {% if page < total_pages %}
                <a class="btn" href="?page={{ page+1 }}{{ base_status }}{{ base_q }}">Następna</a>
              {% else %}
                <span class="btn btn-secondary">Następna</span>
              {% endif %}

              <form method="get" action="" class="page-jump" style="margin-left:0.5rem;">
                <input type="hidden" name="q" value="{{ q or '' }}" />
                <input type="hidden" name="status" value="{{ status_filter or '' }}" />
                <label for="page_input" class="page-jump__label">Idź do</label>
                <input id="page_input" name="page" type="number" min="1" max="{{ total_pages }}" value="{{ page }}" class="page-jump__input" />
                <button class="page-jump__btn" type="submit">Idź</button>
              </form>
            </div>
            {% endif %}
          </div>



          <div style="margin-top: 1.25rem; text-align: center">
            <a class="action-link" href="{{ url_for('index') }}">Powrót do strony głównej</a>
          </div>
        </div>
      </div>
    </main>

    <!-- include the same modal markup and script as resident dashboard -->
    <div class="media-modal" id="mediaModal" aria-hidden="true">
      <div class="media-modal__dialog" role="dialog" aria-modal="true">
        <div class="media-modal__header">
          <div class="media-modal__title" id="mediaModalTitle">Podgląd</div>
          <button class="media-modal__close" id="mediaModalClose" aria-label="Zamknij">×</button>
        </div>
        <div class="media-modal__body" id="mediaModalBody"></div>
        <div class="media-modal__actions">
          <a class="btn btn-secondary" id="mediaDownload" href="#">Pobierz</a>
          <button class="btn" id="mediaCloseBtn">Zamknij</button>
        </div>
      </div>
    </div>

    <!-- citizen info modal -->
    <div class="media-modal" id="citizenModal" aria-hidden="true">
      <div class="media-modal__dialog" role="dialog" aria-modal="true">
        <div class="media-modal__header">
          <div class="media-modal__title" id="citizenModalTitle">Dane wnioskodawcy</div>
          <button class="media-modal__close" id="citizenModalClose" aria-label="Zamknij">×</button>
        </div>
        <div class="media-modal__body" id="citizenModalBody">
          <p><strong>ID:</strong> <span id="citizenId">-</span></p>
          <p><strong>Imię:</strong> <span id="citizenFirst">-</span></p>
          <p><strong>Nazwisko:</strong> <span id="citizenLast">-</span></p>
          <p><strong>PESEL:</strong> <span id="citizenPesel">-</span></p>
          <p><strong>Numer telefonu:</strong> <span id="citizenPhone">-</span></p>
          <p><strong>Data urodzenia:</strong> <span id="citizenBirth">-</span></p>
          <p><strong>Adres zameldowania:</strong> <span id="citizenAddress">-</span></p>
          <p><strong>NIP:</strong> <span id="citizenNip">-</span></p>
          <p><strong>E-mail:</strong> <span id="citizenEmail">-</span></p>
          <p><strong>Utworzono:</strong> <span id="citizenCreated">-</span></p>
        </div>
        <div class="media-modal__actions">
          <button class="btn" id="citizenModalCloseBtn">Zamknij</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const modal = document.getElementById('mediaModal');
        const body = document.getElementById('mediaModalBody');
        const title = document.getElementById('mediaModalTitle');
        const closeBtn = document.getElementById('mediaModalClose');
        const closeBtn2 = document.getElementById('mediaCloseBtn');
        const download = document.getElementById('mediaDownload');

        function openModal(type, src, name){
          body.innerHTML = '';
          title.textContent = name || 'Podgląd';
          if(type === 'image'){
            const img = document.createElement('img');
            img.src = src;
            img.alt = name || '';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            body.appendChild(img);
            download.href = src;
            download.setAttribute('download', name || 'image');
          } else if(type === 'pdf'){
            const iframe = document.createElement('iframe');
            iframe.src = src;
            iframe.style.width = '100%';
            iframe.style.height = '80vh';
            iframe.setAttribute('aria-label', name || 'PDF');
            body.appendChild(iframe);
            download.href = src;
          }

          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
        }

        function closeModal(){
          modal.classList.remove('is-open');
          modal.setAttribute('aria-hidden', 'true');
          body.innerHTML = '';
          download.href = '#';
        }

        document.querySelectorAll('.media-thumb').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const type = btn.getAttribute('data-type');
            const src = btn.getAttribute('data-src');
            const name = btn.getAttribute('data-name');
            openModal(type, src, name);
          });
        });

        closeBtn.addEventListener('click', closeModal);
        closeBtn2.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
        document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); });
        // expose openModal for other scripts to reuse
        window.openModal = openModal;
      })();
      // attach handler to filename links that should open modal previews
      document.querySelectorAll('.attachment-link').forEach(el=>{
        el.addEventListener('click', (e)=>{
          const type = el.getAttribute('data-type');
          const src = el.getAttribute('data-src');
          const name = el.getAttribute('data-name');
          // reuse openModal from above
          const openModalFn = (window.openModal || null);
          if(typeof openModalFn === 'function'){
            openModalFn(type, src, name);
          } else {
            // fallback: directly call the local openModal (scoped)
            // create a small helper mirroring above
            const modalLocal = document.getElementById('mediaModal');
            const bodyLocal = document.getElementById('mediaModalBody');
            const titleLocal = document.getElementById('mediaModalTitle');
            const downloadLocal = document.getElementById('mediaDownload');
            bodyLocal.innerHTML = '';
            titleLocal.textContent = name || 'Podgląd';
            if(type === 'image'){
              const img = document.createElement('img'); img.src = src; img.alt = name || ''; img.style.maxWidth = '100%'; img.style.height = 'auto'; bodyLocal.appendChild(img); downloadLocal.href = src; downloadLocal.setAttribute('download', name || 'image');
            } else if(type === 'pdf'){
              const iframe = document.createElement('iframe'); iframe.src = src; iframe.style.width = '100%'; iframe.style.height = '80vh'; iframe.setAttribute('aria-label', name || 'PDF'); bodyLocal.appendChild(iframe); downloadLocal.href = src;
            }
            modalLocal.classList.add('is-open'); modalLocal.setAttribute('aria-hidden','false');
          }
        });
      });
      function confirmDecision(form){
        const action = form.querySelector('input[name="action"]').value;
        const msg = action === 'approve' ? 'Czy na pewno zatwierdzić ten wniosek?' : 'Czy na pewno odrzucić ten wniosek?';
        return confirm(msg);
      }
      // AJAX decision handler
      document.querySelectorAll('.ajax-decision').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const action = btn.getAttribute('data-action');
          const appId = btn.getAttribute('data-app-id');
          const msg = action === 'approve' ? 'Czy na pewno zatwierdzić ten wniosek?' : 'Czy na pewno odrzucić ten wniosek?';
          if(!confirm(msg)) return;

          try{
            const form = new FormData();
            form.append('action', action);
            const res = await fetch(`{{ url_for('decide_application', app_id=0) }}`.replace('/0/', `/${appId}/`), {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
              body: form,
            });
            if(!res.ok){
              const data = await res.json().catch(()=>({}));
              alert('Błąd: ' + (data.error || res.statusText));
              return;
            }
            const data = await res.json();
            if(data.ok){
              // update status badge in the row
              const row = btn.closest('tr');
              const badge = row.querySelector('.status-badge');
              if(badge){
                badge.textContent = data.new_status === 'approved' ? 'Zatwierdzony' : 'Odrzucony';
                badge.className = 'status-badge status-' + data.new_status;
              }
            }
          }catch(err){
            console.error(err);
            alert('Wystąpił błąd podczas przetwarzania żądania.');
          }
        });
      });

      // citizen info modal handlers
      (function(){
        const citModal = document.getElementById('citizenModal');
        const citBody = document.getElementById('citizenModalBody');
        const citTitle = document.getElementById('citizenModalTitle');
        const citClose = document.getElementById('citizenModalClose');
        const citCloseBtn = document.getElementById('citizenModalCloseBtn');

        async function openCitizenModal(citizenId){
          // fetch info
          try{
            const res = await fetch(`/citizen/${citizenId}/info`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
            if(!res.ok){
              alert('Nie można pobrać danych wnioskodawcy');
              return;
            }
            const data = await res.json();
            if(!data.ok){
              alert('Błąd: ' + (data.error||'nieznany'));
              return;
            }
            document.getElementById('citizenId').textContent = data.id || '-';
            document.getElementById('citizenFirst').textContent = data.first_name || '-';
            document.getElementById('citizenLast').textContent = data.last_name || '-';
            document.getElementById('citizenPesel').textContent = data.pesel || '-';
            document.getElementById('citizenPhone').textContent = data.phone_number || '-';
            document.getElementById('citizenBirth').textContent = data.birth_date || '-';
            document.getElementById('citizenAddress').textContent = data.reg_address || '-';
            document.getElementById('citizenNip').textContent = data.nip || '-';
            document.getElementById('citizenEmail').textContent = data.email || '-';
            document.getElementById('citizenCreated').textContent = data.creation_date || '-';
            citModal.classList.add('is-open');
            citModal.setAttribute('aria-hidden','false');
          }catch(err){
            console.error(err);
            alert('Wystąpił błąd przy pobieraniu danych.');
          }
        }

        function closeCitizenModal(){
          citModal.classList.remove('is-open');
          citModal.setAttribute('aria-hidden','true');
        }

        document.querySelectorAll('.citizen-link').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            const id = btn.getAttribute('data-citizen-id');
            if(id) openCitizenModal(id);
          });
        });

        citClose.addEventListener('click', closeCitizenModal);
        citCloseBtn.addEventListener('click', closeCitizenModal);
        citModal.addEventListener('click', (e)=>{ if(e.target === citModal) closeCitizenModal(); });
      })();
    </script>
    <script>
      // pickup modal handlers (shared with resident dashboard)
      (function(){
        const modal = document.createElement('div');
        // build modal HTML and append to body
        modal.innerHTML = `
          <div class="media-modal" id="pickupModal" aria-hidden="true">
            <div class="media-modal__dialog" role="dialog" aria-modal="true">
              <div class="media-modal__header">
                <div class="media-modal__title" id="pickupModalTitle">Informacje o pobiorze</div>
                <button class="media-modal__close" id="pickupModalClose" aria-label="Zamknij">×</button>
              </div>
              <div class="media-modal__body" id="pickupModalBody">
                <p><strong>Adres:</strong> <span id="pickupAddress">-</span></p>
                <p><strong>Liczba worków:</strong> <span id="pickupBags">-</span> <small id="pickupPaid" style="color:#c33"></small></p>
                <p><strong>Data dostarczenia:</strong> <span id="pickupArrival">-</span></p>
                <p><strong>Data odbioru:</strong> <span id="pickupDepart">-</span></p>
                <p><strong>Notatki:</strong> <span id="pickupNotes">-</span></p>
                <p><strong>Załączniki:</strong> <span id="pickupAttachments">-</span></p>
              </div>
              <div class="media-modal__actions">
                <button class="btn" id="pickupModalCloseBtn">Zamknij</button>
              </div>
            </div>
          </div>`;
        document.body.appendChild(modal);

        // wire handlers
        function openPickupFromBtn(btn){
          const m = document.getElementById('pickupModal');
          const addr = `ul. ${btn.getAttribute('data-street') || '-'} ${btn.getAttribute('data-building') || ''}${btn.getAttribute('data-apartment') ? ('/' + btn.getAttribute('data-apartment')) : ''}`;
          document.getElementById('pickupAddress').textContent = addr;
          const bags = btn.getAttribute('data-bag-count') || '0';
          const paid = btn.getAttribute('data-paid-bags') || '0';
          document.getElementById('pickupBags').textContent = bags;
          document.getElementById('pickupPaid').textContent = (paid && Number(paid) > 0) ? `${paid} płatne` : '';
          document.getElementById('pickupArrival').textContent = btn.getAttribute('data-arrival') || '-';
          document.getElementById('pickupDepart').textContent = btn.getAttribute('data-depart') || '-';
          document.getElementById('pickupNotes').textContent = btn.getAttribute('data-notes') || '-';
          const atts = (btn.getAttribute('data-attachments') || '').split('|||').filter(Boolean);
          document.getElementById('pickupAttachments').textContent = atts.length ? atts.join(', ') : '-';
          m.classList.add('is-open'); m.setAttribute('aria-hidden','false');
        }

        // delegate click handlers to existing buttons
        document.addEventListener('click', function(e){
          const btn = e.target.closest('.pickup-info');
          if(btn){
            e.preventDefault();
            openPickupFromBtn(btn);
          }
        });

        // close handlers
        document.addEventListener('click', function(e){
          if(e.target && (e.target.id === 'pickupModalClose' || e.target.id === 'pickupModalCloseBtn')){
            const m = document.getElementById('pickupModal'); if(m){ m.classList.remove('is-open'); m.setAttribute('aria-hidden','true'); }
          }
        });
        document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ const m = document.getElementById('pickupModal'); if(m){ m.classList.remove('is-open'); m.setAttribute('aria-hidden','true'); } } });
      })();
    </script>
    <script>
      // sector modal for staff
      (function(){
        const sectorModalHtml = `
          <div class="media-modal" id="sectorModal" aria-hidden="true">
            <div class="media-modal__dialog" role="dialog" aria-modal="true">
              <div class="media-modal__header">
                <div class="media-modal__title">Sektor</div>
                <button class="media-modal__close" id="sectorModalClose" aria-label="Zamknij">×</button>
              </div>
              <div class="media-modal__body">
                <p><strong>ID sektora:</strong> <span id="sectorId">-</span></p>
                <p><strong>Firma zarządzająca:</strong> <span id="sectorCompany">-</span></p>
              </div>
              <div class="media-modal__actions"><button class="btn" id="sectorCloseBtn">Zamknij</button></div>
            </div>
          </div>`;
        const wrapper = document.createElement('div'); wrapper.innerHTML = sectorModalHtml; document.body.appendChild(wrapper);
        function openSector(btn){ const id = btn.getAttribute('data-sector-id') || '-'; const comp = btn.getAttribute('data-sector-company') || '-'; document.getElementById('sectorId').textContent = id; document.getElementById('sectorCompany').textContent = comp; const m = document.getElementById('sectorModal'); m.classList.add('is-open'); m.setAttribute('aria-hidden','false'); }
        function closeSector(){ const m=document.getElementById('sectorModal'); if(m){ m.classList.remove('is-open'); m.setAttribute('aria-hidden','true'); }}
        document.addEventListener('click', function(e){ const b = e.target.closest('.sector-info'); if(b){ e.preventDefault(); openSector(b); } if(e.target && (e.target.id==='sectorModalClose' || e.target.id==='sectorCloseBtn')) closeSector(); });
        document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeSector(); });
      })();
    </script>
  </body>
</html>
