<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel urzÄ™dnika â€” BigBag</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}" />
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="brand" href="{{ url_for('index') }}">PÅ‚ockiBigBag.pl</a>
      </div>
    </header>

    <main class="auth-viewport">
      <div class="auth-container">
        <div class="auth-card" role="main">
          <div id="dashboard-header">
            <h1>Panel urzÄ™dnika</h1>
          </div>
          <p class="lead">Lista wszystkich wnioskÃ³w</p>

          <div style="margin-top: 1.5rem; width: 100%">
            <form method="get" action="" style="display:flex; gap:0.5rem; align-items:center; margin-bottom:0.75rem; flex-wrap:wrap;">
              <label for="filter_status">Status</label>
              <select id="filter_status" name="status">
                <option value="">Wszystkie</option>
                <option value="awaiting" {% if status_filter == 'awaiting' %}selected{% endif %}>OczekujÄ…cy</option>
                <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>W trakcie</option>
                <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Zatwierdzony</option>
                <option value="declined" {% if status_filter == 'declined' %}selected{% endif %}>Odrzucony</option>
              </select>
              <label for="filter_q">Szukaj</label>
              <input id="filter_q" name="q" type="search" placeholder="imiÄ™, nazwisko, ulica, email" value="{{ q or '' }}" />
              <button class="btn btn-primary" type="submit">Filtruj</button>
            </form>
            {% if applications and applications|length > 0 %}
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Wnioskodawca</th>
                    <th>Adres</th>
                    <th>ZaÅ‚Ä…cznik</th>
                    <th>Status</th>
                    <th>Worki</th>
                    <th>Data dostarczenia</th>
                    <th>Data odbioru</th>
                    <th>Utworzono</th>
                    <th>Akcje</th>
                  </tr>
                </thead>
                <tbody>
                  {% for a in applications %}
                  <tr>
                    <td>{{ a.id_application }}</td>
                    <td>{{ a.first_name }} {{ a.last_name }}<br/><small>{{ a.email }}</small></td>
                    <td>ul. {{ a.street }} {{ a.building_number }}{% if a.apartment_number %}/{{ a.apartment_number }}{% endif %}</td>
                    <td>
                      {% set atts = attachments_map.get(a.id_application) if attachments_map else None %}
                      {% if atts and atts|length > 0 %}
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                          {% for att in atts %}
                            {% set src = url_for('serve_attachment', attachment_id=att.id_attachment) %}
                            {% if att.file_type and att.file_type.startswith('image/') %}
                              <button class="media-thumb" data-type="image" data-src="{{ src }}" data-name="{{ att.file_name }}" style="border:0; background:transparent; padding:0;">
                                <img src="{{ src }}" alt="{{ att.file_name }}" style="height:48px; width:auto; border-radius:4px; display:block;" />
                              </button>
                            {% elif att.file_type == 'application/pdf' %}
                              <button class="media-thumb" data-type="pdf" data-src="{{ src }}" data-name="{{ att.file_name }}" style="border:0; background:transparent; padding:0; color:var(--accent); font-weight:600;">
                                ðŸ“„ {{ att.file_name }}
                              </button>
                            {% else %}
                              <a class="action-link" href="{{ url_for('attachment_view', attachment_id=att.id_attachment) }}" target="_blank" rel="noopener">{{ att.file_name }}</a>
                            {% endif %}
                          {% endfor %}
                        </div>
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% set status_label = '???' %}
                      {% if a.status == 'awaiting' %}
                        {% set status_label = 'OczekujÄ…cy' %}
                      {% elif a.status == 'in_progress' %}
                        {% set status_label = 'W trakcie' %}
                      {% elif a.status == 'approved' %}
                        {% set status_label = 'Zatwierdzony' %}
                      {% elif a.status == 'declined' %}
                        {% set status_label = 'Odrzucony' %}
                      {% else %}
                        {% set status_label = a.status %}
                      {% endif %}
                      <span class="status-badge status-{{ a.status|replace(' ', '_') }}">{{ status_label }}</span>
                    </td>
                    <td>{{ a.bag_count }}</td>
                    <td>{{ a.bag_arrival_date or '-' }}</td>
                    <td>{{ a.bag_depart_date or '-' }}</td>
                    <td>{{ a.creation_date }}</td>
                    <td>
                      <div style="display:flex; gap:0.4rem;">
                        <button class="btn btn-primary ajax-decision" data-app-id="{{ a.id_application }}" data-action="approve">ZatwierdÅº</button>
                        <button class="btn btn-secondary ajax-decision" data-app-id="{{ a.id_application }}" data-action="decline">OdrzuÄ‡</button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p>Brak wnioskÃ³w.</p>
            {% endif %}

            {% if total_pages and total_pages > 1 %}
            <div style="display:flex; gap:0.5rem; align-items:center; justify-content:center; margin-top:0.75rem; flex-wrap:wrap;">
              {% set base_q = ('&q=' ~ q) if q else '' %}
              {% set base_status = ('&status=' ~ status_filter) if status_filter else '' %}
              {% if page > 1 %}
                <a class="btn" href="?page={{ page-1 }}{{ base_status }}{{ base_q }}">Poprzednia</a>
              {% else %}
                <span class="btn btn-secondary">Poprzednia</span>
              {% endif %}

              {% set start = page - 2 if page - 2 > 1 else 1 %}
              {% set end = page + 2 if page + 2 < total_pages else total_pages %}

              {% if start > 1 %}
                <a class="btn" href="?page=1{{ base_status }}{{ base_q }}">1</a>
                {% if start > 2 %}
                  <span class="btn btn-secondary">â€¦</span>
                {% endif %}
              {% endif %}

              {% for p in range(start, end+1) %}
                {% if p == page %}
                  <span class="btn btn-secondary" style="font-weight:700;">{{ p }}</span>
                {% else %}
                  <a class="btn" href="?page={{ p }}{{ base_status }}{{ base_q }}">{{ p }}</a>
                {% endif %}
              {% endfor %}

              {% if end < total_pages %}
                {% if end < total_pages - 1 %}
                  <span class="btn btn-secondary">â€¦</span>
                {% endif %}
                <a class="btn" href="?page={{ total_pages }}{{ base_status }}{{ base_q }}">{{ total_pages }}</a>
              {% endif %}

              {% if page < total_pages %}
                <a class="btn" href="?page={{ page+1 }}{{ base_status }}{{ base_q }}">NastÄ™pna</a>
              {% else %}
                <span class="btn btn-secondary">NastÄ™pna</span>
              {% endif %}

              <form method="get" action="" class="page-jump" style="margin-left:0.5rem;">
                <input type="hidden" name="q" value="{{ q or '' }}" />
                <input type="hidden" name="status" value="{{ status_filter or '' }}" />
                <label for="page_input" class="page-jump__label">IdÅº do</label>
                <input id="page_input" name="page" type="number" min="1" max="{{ total_pages }}" value="{{ page }}" class="page-jump__input" />
                <button class="page-jump__btn" type="submit">IdÅº</button>
              </form>
            </div>
            {% endif %}
          </div>



          <div style="margin-top: 1.25rem; text-align: center">
            <a class="action-link" href="{{ url_for('index') }}">PowrÃ³t do strony gÅ‚Ã³wnej</a>
          </div>
        </div>
      </div>
    </main>

    <!-- include the same modal markup and script as resident dashboard -->
    <div class="media-modal" id="mediaModal" aria-hidden="true">
      <div class="media-modal__dialog" role="dialog" aria-modal="true">
        <div class="media-modal__header">
          <div class="media-modal__title" id="mediaModalTitle">PodglÄ…d</div>
          <button class="media-modal__close" id="mediaModalClose" aria-label="Zamknij">Ã—</button>
        </div>
        <div class="media-modal__body" id="mediaModalBody"></div>
        <div class="media-modal__actions">
          <a class="btn btn-secondary" id="mediaDownload" href="#">Pobierz</a>
          <button class="btn" id="mediaCloseBtn">Zamknij</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const modal = document.getElementById('mediaModal');
        const body = document.getElementById('mediaModalBody');
        const title = document.getElementById('mediaModalTitle');
        const closeBtn = document.getElementById('mediaModalClose');
        const closeBtn2 = document.getElementById('mediaCloseBtn');
        const download = document.getElementById('mediaDownload');

        function openModal(type, src, name){
          body.innerHTML = '';
          title.textContent = name || 'PodglÄ…d';
          if(type === 'image'){
            const img = document.createElement('img');
            img.src = src;
            img.alt = name || '';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            body.appendChild(img);
            download.href = src;
            download.setAttribute('download', name || 'image');
          } else if(type === 'pdf'){
            const iframe = document.createElement('iframe');
            iframe.src = src;
            iframe.style.width = '100%';
            iframe.style.height = '80vh';
            iframe.setAttribute('aria-label', name || 'PDF');
            body.appendChild(iframe);
            download.href = src;
          }

          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
        }

        function closeModal(){
          modal.classList.remove('is-open');
          modal.setAttribute('aria-hidden', 'true');
          body.innerHTML = '';
          download.href = '#';
        }

        document.querySelectorAll('.media-thumb').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const type = btn.getAttribute('data-type');
            const src = btn.getAttribute('data-src');
            const name = btn.getAttribute('data-name');
            openModal(type, src, name);
          });
        });

        closeBtn.addEventListener('click', closeModal);
        closeBtn2.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
        document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); });
      })();
      function confirmDecision(form){
        const action = form.querySelector('input[name="action"]').value;
        const msg = action === 'approve' ? 'Czy na pewno zatwierdziÄ‡ ten wniosek?' : 'Czy na pewno odrzuciÄ‡ ten wniosek?';
        return confirm(msg);
      }
      // AJAX decision handler
      document.querySelectorAll('.ajax-decision').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const action = btn.getAttribute('data-action');
          const appId = btn.getAttribute('data-app-id');
          const msg = action === 'approve' ? 'Czy na pewno zatwierdziÄ‡ ten wniosek?' : 'Czy na pewno odrzuciÄ‡ ten wniosek?';
          if(!confirm(msg)) return;

          try{
            const form = new FormData();
            form.append('action', action);
            const res = await fetch(`{{ url_for('decide_application', app_id=0) }}`.replace('/0/', `/${appId}/`), {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
              body: form,
            });
            if(!res.ok){
              const data = await res.json().catch(()=>({}));
              alert('BÅ‚Ä…d: ' + (data.error || res.statusText));
              return;
            }
            const data = await res.json();
            if(data.ok){
              // update status badge in the row
              const row = btn.closest('tr');
              const badge = row.querySelector('.status-badge');
              if(badge){
                badge.textContent = data.new_status === 'approved' ? 'Zatwierdzony' : 'Odrzucony';
                badge.className = 'status-badge status-' + data.new_status;
              }
            }
          }catch(err){
            console.error(err);
            alert('WystÄ…piÅ‚ bÅ‚Ä…d podczas przetwarzania Å¼Ä…dania.');
          }
        });
      });
    </script>
  </body>
</html>
