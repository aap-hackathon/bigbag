<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel mieszka≈Ñca ‚Äî BigBag</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/base.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/auth.css') }}"
    />
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="brand" href="{{ url_for('index') }}">P≈ÇockiBigBag.pl</a>
      </div>
    </header>

    <main class="auth-viewport">
      <div class="auth-container">
        <div class="auth-card" role="main">
          <div id="dashboard-header">
            <h1>Witaj w panelu mieszka≈Ñca, {{ current_user.first_name }}!</h1>
          </div>
          <p class="lead">
            Z tego miejsca mo≈ºesz wys≈Çaƒá nowy wniosek lub zobaczyƒá listƒô swoich
            zg≈Çosze≈Ñ.
          </p>

          <div
            style="
              display: flex;
              flex-direction: column;
              gap: 1rem;
              align-items: center;
              margin-top: 1.5rem;
            "
          >
            <a class="btn btn-primary" href="{{ url_for('application_form') }}"
              >Wy≈õlij nowy wniosek</a
            >
          </div>

          <!-- Applications table -->
          <div style="margin-top: 1.5rem; width: 100%">
            <h2>Twoje wnioski</h2>
            {% if applications and applications|length > 0 %}
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Adres</th>
                    <th>Za≈ÇƒÖcznik</th>
                    <th>Status</th>
                    <th>Worki</th>
                    <th>Data dostarczenia</th>
                    <th>Data odbioru</th>
                    <th>Utworzono</th>
                    <th>Akcje</th>
                  </tr>
                </thead>
                <tbody>
                  {% for a in applications %}
                  <tr>
                    <td>{{ a.id_application }}</td>
                    <td>
                      ul. {{ a.street }} {{ a.building_number }}{% if a.apartment_number %}/{{ a.apartment_number }}{% endif %}
                    </td>
                    <td>
                      {% set atts = attachments_map.get(a.id_application) if attachments_map else None %}
                      {% if atts and atts|length > 0 %}
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                          {% for att in atts %}
                            {% set src = url_for('serve_attachment', attachment_id=att.id_attachment) %}
                            {% if att.file_type and att.file_type.startswith('image/') %}
                              <button class="media-thumb" data-type="image" data-src="{{ src }}" data-name="{{ att.file_name }}" style="border:0; background:transparent; padding:0;">
                                <img src="{{ src }}" alt="{{ att.file_name }}" style="height:48px; width:auto; border-radius:4px; display:block;" />
                              </button>
                            {% elif att.file_type == 'application/pdf' %}
                              <button class="media-thumb" data-type="pdf" data-src="{{ src }}" data-name="{{ att.file_name }}" style="border:0; background:transparent; padding:0; color:var(--accent); font-weight:600;">
                                üìÑ {{ att.file_name }}
                              </button>
                            {% else %}
                              <a class="action-link" href="{{ url_for('attachment_view', attachment_id=att.id_attachment) }}" target="_blank" rel="noopener">{{ att.file_name }}</a>
                            {% endif %}
                          {% endfor %}
                        </div>
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% set status_label = '???' %}
                      {% if a.status == 'awaiting' %}
                        {% set status_label = 'OczekujƒÖcy' %}
                      {% elif a.status == 'in_progress' %}
                        {% set status_label = 'W trakcie' %}
                      {% elif a.status == 'approved' %}
                        {% set status_label = 'Zatwierdzony' %}
                      {% elif a.status == 'declined' %}
                        {% set status_label = 'Odrzucony' %}
                      {% else %}
                        {% set status_label = a.status %}
                      {% endif %}
                      <span class="status-badge status-{{ a.status|replace(' ', '_') }}">{{ status_label }}</span>
                    </td>
                    <td>{{ a.bag_count }}</td>
                    <td>{{ a.bag_arrival_date or '-' }}</td>
                    <td>{{ a.bag_depart_date or '-' }}</td>
                    <td>{{ a.creation_date }}</td>
                    <td>
                      <!-- placeholder for actions -->
                      <a class="action-link" href="#">Poka≈º</a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p>Nie wys≈Ça≈Çe≈õ jeszcze ≈ºadnych wniosk√≥w.</p>
            {% endif %}
            <!-- pagination controls -->
            {% if total_pages and total_pages > 1 %}
            <div style="display:flex; gap:0.5rem; justify-content:center; margin-top:0.75rem;">
              {% if page > 1 %}
                <a class="btn" href="?page={{ page-1 }}">Poprzednia</a>
              {% endif %}
              {% for p in range(1, total_pages+1) %}
                {% if p == page %}
                  <span class="btn btn-secondary" style="font-weight:700;">{{ p }}</span>
                {% else %}
                  <a class="btn" href="?page={{ p }}">{{ p }}</a>
                {% endif %}
              {% endfor %}
              {% if page < total_pages %}
                <a class="btn" href="?page={{ page+1 }}">Nastƒôpna</a>
              {% endif %}
            </div>
            {% endif %}
          </div>



          <div style="margin-top: 1.25rem; text-align: center">
            <a class="action-link" href="{{ url_for('index') }}"
              >Powr√≥t do strony g≈Ç√≥wnej</a
            >
          </div>
        </div>
      </div>
    </main>

    <!-- Modal for media preview -->
    <div class="media-modal" id="mediaModal" aria-hidden="true">
      <div class="media-modal__dialog" role="dialog" aria-modal="true">
        <div class="media-modal__header">
          <div class="media-modal__title" id="mediaModalTitle">PodglƒÖd</div>
          <button class="media-modal__close" id="mediaModalClose" aria-label="Zamknij">√ó</button>
        </div>
        <div class="media-modal__body" id="mediaModalBody">
          <!-- dynamic content: img or iframe -->
        </div>
        <div class="media-modal__actions">
          <a class="btn btn-secondary" id="mediaDownload" href="#">Pobierz</a>
          <button class="btn" id="mediaCloseBtn">Zamknij</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const modal = document.getElementById('mediaModal');
        const body = document.getElementById('mediaModalBody');
        const title = document.getElementById('mediaModalTitle');
        const closeBtn = document.getElementById('mediaModalClose');
        const closeBtn2 = document.getElementById('mediaCloseBtn');
        const download = document.getElementById('mediaDownload');

        function openModal(type, src, name){
          body.innerHTML = '';
          title.textContent = name || 'PodglƒÖd';
          if(type === 'image'){
            const img = document.createElement('img');
            img.src = src;
            img.alt = name || '';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            body.appendChild(img);
            download.href = src;
            download.setAttribute('download', name || 'image');
          } else if(type === 'pdf'){
            const iframe = document.createElement('iframe');
            iframe.src = src;
            iframe.style.width = '100%';
            iframe.style.height = '80vh';
            iframe.setAttribute('aria-label', name || 'PDF');
            body.appendChild(iframe);
            download.href = src;
          }

          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
        }

        function closeModal(){
          modal.classList.remove('is-open');
          modal.setAttribute('aria-hidden', 'true');
          body.innerHTML = '';
          download.href = '#';
        }

        document.querySelectorAll('.media-thumb').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const type = btn.getAttribute('data-type');
            const src = btn.getAttribute('data-src');
            const name = btn.getAttribute('data-name');
            openModal(type, src, name);
          });
        });

        closeBtn.addEventListener('click', closeModal);
        closeBtn2.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
        document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); });
      })();
    </script>
  </body>
</html>
