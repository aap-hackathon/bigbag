<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel mieszkańca — BigBag</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/base.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/auth.css') }}"
    />
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="brand" href="{{ url_for('index') }}">PłockiBigBag.pl</a>
      </div>
    </header>

    <main class="auth-viewport">
      <div class="auth-container">
        <div class="auth-card" role="main">
          <div id="dashboard-header">
            <h1>Witaj w panelu mieszkańca, {{ current_user.first_name }}!</h1>
          </div>
          <p class="lead">
            Z tego miejsca możesz wysłać nowy wniosek lub zobaczyć listę swoich
            zgłoszeń.
          </p>

          <div style="display:flex; flex-direction:row; gap:1rem; align-items:center; margin-top:1.5rem;">
            <a class="btn btn-primary" href="{{ url_for('application_form') }}">Wyślij nowy wniosek</a>
          </div>

          <!-- Applications table -->
          <div style="margin-top: 1.5rem; width: 100%">
            <h2>Twoje wnioski</h2>
            <form method="get" action="" style="display:flex; gap:0.5rem; align-items:center; margin-bottom:0.75rem; flex-wrap:wrap;">
              <label for="filter_status">Status</label>
              <select id="filter_status" name="status">
                <option value="">Wszystkie</option>
                <option value="awaiting" {% if status_filter == 'awaiting' %}selected{% endif %}>Oczekujący</option>
                <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>W trakcie</option>
                <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Zatwierdzony</option>
                <option value="declined" {% if status_filter == 'declined' %}selected{% endif %}>Odrzucony</option>
              </select>
              <label for="filter_q">Szukaj</label>
              <input id="filter_q" name="q" type="search" placeholder="ulica, numer, rok (YYYY) lub data (YYYY-MM-DD)" value="{{ q or '' }}" />
              <button class="btn btn-primary" type="submit">Filtruj</button>
            </form>
            {% if applications and applications|length > 0 %}
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Adres</th>
                    <th>Załącznik</th>
                    <th>Status</th>
                    <th>Worki</th>
                    <th>Data dostarczenia</th>
                    <th>Data odbioru</th>
                    <th>Utworzono</th>
                    <th>Akcje</th>
                  </tr>
                </thead>
                <tbody>
                  {% for a in applications %}
                  <tr>
                    <td>{{ a.id_application }}</td>
                    <td>
                      ul. {{ a.street }} {{ a.building_number }}{% if a.apartment_number %}/{{ a.apartment_number }}{% endif %}
                    </td>
                    <td>
                      {% set atts = attachments_map.get(a.id_application) if attachments_map else None %}
                      {% if atts and atts|length > 0 %}
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                              {% for att in atts %}
                                {% set src = url_for('serve_attachment', attachment_id=att.id_attachment) %}
                                {% if att.file_type and (att.file_type.startswith('image/') or att.file_type == 'application/pdf') %}
                                  {# show filename only, preview in modal on click #}
                                  <button class="attachment-link" data-type="{{ 'image' if att.file_type.startswith('image/') else 'pdf' }}" data-src="{{ src }}" data-name="{{ att.file_name }}" style="border:0; background:transparent; padding:0; color:var(--accent); font-weight:600; text-decoration:underline; cursor:pointer;">
                                    {{ att.file_name }}
                                  </button>
                                {% else %}
                                  <a class="action-link" href="{{ url_for('attachment_view', attachment_id=att.id_attachment) }}" target="_blank" rel="noopener">{{ att.file_name }}</a>
                                {% endif %}
                              {% endfor %}
                        </div>
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% set status_label = '???' %}
                      {% if a.status == 'awaiting' %}
                        {% set status_label = 'Oczekujący' %}
                      {% elif a.status == 'in_progress' %}
                        {% set status_label = 'W trakcie' %}
                      {% elif a.status == 'approved' %}
                        {% set status_label = 'Zatwierdzony' %}
                      {% elif a.status == 'declined' %}
                        {% set status_label = 'Odrzucony' %}
                      {% else %}
                        {% set status_label = a.status %}
                      {% endif %}
                      <span class="status-badge status-{{ a.status|replace(' ', '_') }}">{{ status_label }}</span>
                    </td>
                    <td>{{ a.bag_count }}</td>
                    <td>{{ a.bag_arrival_date or '-' }}</td>
                    <td>{{ a.bag_depart_date or '-' }}</td>
                    <td>{{ a.creation_date }}</td>
                    <td>
                      <!-- actions: only print now -->
                      {% set att_names = '' %}
                      {% if atts and atts|length > 0 %}
                        {% set att_names = atts | map(attribute='file_name') | join('|||') %}
                      {% endif %}
                      <button class="btn btn-sm" data-action="print" data-id="{{ a.id_application }}" data-first-name="{{ a.first_name or current_user.first_name or '' }}" data-last-name="{{ a.last_name or current_user.last_name or '' }}" data-street="{{ a.street }}" data-building="{{ a.building_number }}" data-apartment="{{ a.apartment_number or '' }}" data-bag-count="{{ a.bag_count or '' }}" data-status="{{ a.status }}" data-attachments="{{ att_names }}">Drukuj</button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p>Nie wysłałeś jeszcze żadnych wniosków.</p>
            {% endif %}
            <!-- smarter pagination controls -->
            {% if total_pages and total_pages > 1 %}
            <div class="pagination-controls">
              {% set base_q = ('&q=' ~ q) if q else '' %}
              {% set base_status = ('&status=' ~ status_filter) if status_filter else '' %}
              {% if page > 1 %}
                <a class="btn" href="?page={{ page-1 }}{{ base_status }}{{ base_q }}">Poprzednia</a>
              {% else %}
                <span class="btn btn-secondary">Poprzednia</span>
              {% endif %}

              {% set start = page - 2 if page - 2 > 1 else 1 %}
              {% set end = page + 2 if page + 2 < total_pages else total_pages %}

              {% if start > 1 %}
                  <a class="btn" href="?page=1{{ base_status }}{{ base_q }}">1</a>
                {% if start > 2 %}
                  <span class="btn btn-secondary">…</span>
                {% endif %}
              {% endif %}

              {% for p in range(start, end+1) %}
                {% if p == page %}
                  <span class="btn btn-secondary" style="font-weight:700;">{{ p }}</span>
                {% else %}
                  <a class="btn" href="?page={{ p }}{{ base_status }}{{ base_q }}">{{ p }}</a>
                {% endif %}
              {% endfor %}

              {% if end < total_pages %}
                {% if end < total_pages - 1 %}
                  <span class="btn btn-secondary">…</span>
                {% endif %}
                <a class="btn" href="?page={{ total_pages }}{{ base_status }}{{ base_q }}">{{ total_pages }}</a>
              {% endif %}

              {% if page < total_pages %}
                <a class="btn" href="?page={{ page+1 }}{{ base_status }}{{ base_q }}">Następna</a>
              {% else %}
                <span class="btn btn-secondary">Następna</span>
              {% endif %}

              <form method="get" action="" class="page-jump" style="margin-left:0.5rem;">
                <input type="hidden" name="q" value="{{ q or '' }}" />
                <input type="hidden" name="status" value="{{ status_filter or '' }}" />
                <label for="page_input" class="page-jump__label">Idź do</label>
                <input id="page_input" name="page" type="number" min="1" max="{{ total_pages }}" value="{{ page }}" class="page-jump__input" />
                <button class="page-jump__btn" type="submit">Idź</button>
              </form>
            </div>
            {% endif %}
          </div>



          <div style="margin-top: 1.25rem; text-align: center">
            <a class="action-link" href="{{ url_for('index') }}"
              >Powrót do strony głównej</a
            >
          </div>
        </div>
      </div>
    </main>

    <!-- Modal for media preview -->
    <div class="media-modal" id="mediaModal" aria-hidden="true">
      <div class="media-modal__dialog" role="dialog" aria-modal="true">
        <div class="media-modal__header">
          <div class="media-modal__title" id="mediaModalTitle">Podgląd</div>
          <button class="media-modal__close" id="mediaModalClose" aria-label="Zamknij">×</button>
        </div>
        <div class="media-modal__body" id="mediaModalBody">
          <!-- dynamic content: img or iframe -->
        </div>
        <div class="media-modal__actions">
          <a class="btn btn-secondary" id="mediaDownload" href="#">Pobierz</a>
          <button class="btn" id="mediaCloseBtn">Zamknij</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const modal = document.getElementById('mediaModal');
        const body = document.getElementById('mediaModalBody');
        const title = document.getElementById('mediaModalTitle');
        const closeBtn = document.getElementById('mediaModalClose');
        const closeBtn2 = document.getElementById('mediaCloseBtn');
        const download = document.getElementById('mediaDownload');

        function openModal(type, src, name){
          body.innerHTML = '';
          title.textContent = name || 'Podgląd';
          if(type === 'image'){
            const img = document.createElement('img');
            img.src = src;
            img.alt = name || '';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            body.appendChild(img);
            download.href = src;
            download.setAttribute('download', name || 'image');
          } else if(type === 'pdf'){
            const iframe = document.createElement('iframe');
            iframe.src = src;
            iframe.style.width = '100%';
            iframe.style.height = '80vh';
            iframe.setAttribute('aria-label', name || 'PDF');
            body.appendChild(iframe);
            download.href = src;
          }

          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
        }

        function closeModal(){
          modal.classList.remove('is-open');
          modal.setAttribute('aria-hidden', 'true');
          body.innerHTML = '';
          download.href = '#';
        }

        document.querySelectorAll('.media-thumb').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const type = btn.getAttribute('data-type');
            const src = btn.getAttribute('data-src');
            const name = btn.getAttribute('data-name');
            openModal(type, src, name);
          });
        });

        // new: attach handler to filename links that should open modal previews
        document.querySelectorAll('.attachment-link').forEach(el=>{
          el.addEventListener('click', (e)=>{
            const type = el.getAttribute('data-type');
            const src = el.getAttribute('data-src');
            const name = el.getAttribute('data-name');
            openModal(type, src, name);
          });
        });

        closeBtn.addEventListener('click', closeModal);
        closeBtn2.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
        document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); });
      })();
    </script>
    <script>
      // Print helper: builds a minimal printable document with application data and opens print dialog
      (function(){
        function buildHtml(data){
          const attachmentsHtml = (data.attachments && data.attachments.length) ? data.attachments.map(a=>`<div>${a}</div>`).join('') : '<div>-</div>';
          const address = `ul. ${data.street || '-'} ${data.building || ''}${data.apartment?('/'+data.apartment):''}`;
          return `<!doctype html><html><head><meta charset="utf-8"><title>Potwierdzenie wniosku #${data.id}</title><style>
            body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:24px;color:#0b1720}
            .hdr{display:flex;justify-content:space-between;align-items:center}
            h1{font-size:1.25rem}
            table{width:100%;border-collapse:collapse;margin-top:12px}
            td,th{padding:8px;border:1px solid #e6e6e6;text-align:left}
            .muted{color:#556}
          </style></head><body>
            <div class="hdr"><h1>Potwierdzenie złożenia wniosku</h1><div class="muted">ID: ${data.id}</div></div>
            <p class="muted">Data wygenerowania: ${new Date().toLocaleString()}</p>
            <table>
              <tr><th>ID wniosku</th><td>${data.id}</td></tr>
              <tr><th>Adres</th><td>${address}</td></tr>
              <tr><th>Liczba worków</th><td>${data.bag_count || '-'}</td></tr>
              <tr><th>Status</th><td>${data.status || '-'}</td></tr>
              <tr><th>Załączniki</th><td>${attachmentsHtml}</td></tr>
            </table>
          </body></html>`;
        }

        const STATUS_MAP = {
          'awaiting': 'Oczekujący',
          'in_progress': 'W trakcie',
          'approved': 'Zatwierdzony',
          'declined': 'Odrzucony'
        };

        document.querySelectorAll('button[data-action="print"]').forEach(btn=>{
          btn.addEventListener('click', function(e){
            e.preventDefault();
            const id = btn.getAttribute('data-id');
            const rawAtt = btn.getAttribute('data-attachments') || '';
            const attachments = rawAtt ? rawAtt.split('|||').filter(Boolean) : [];
            const firstName = btn.getAttribute('data-first-name') || '';
            const lastName = btn.getAttribute('data-last-name') || '';
            const data = {
              id: id,
              first_name: firstName,
              last_name: lastName,
              full_name: (firstName + (lastName ? (' ' + lastName) : '')).trim(),
              street: btn.getAttribute('data-street') || '',
              building: btn.getAttribute('data-building') || '',
              apartment: btn.getAttribute('data-apartment') || '',
              bag_count: btn.getAttribute('data-bag-count') || '',
              status: STATUS_MAP[btn.getAttribute('data-status')] || btn.getAttribute('data-status') || '',
              attachments: attachments
            };

            const w = window.open('', '_blank');
            if(!w) { alert('Pop-up zablokowany — odblokuj, aby wydrukować potwierdzenie'); return }
            w.document.open();
            w.document.write(buildHtml(data));
            w.document.close();
            // Wait briefly for resources to load then print
            setTimeout(()=>{ w.focus(); w.print(); }, 400);
          });
        });
      })();
    </script>
  </body>
</html>
